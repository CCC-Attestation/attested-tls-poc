# Parsec TPM explicit platform attestation

This document covers the technical details of explicit platform attestation using a TPM2.0.

The attestation and verification process revolve around a signed attestation token, and the extra data required to verify it.

## TPM Platform Attestation Statement Format

While for key attestation we can use the format supplied by WebAuthn for that use-case, and while other WebAuthn attestation statement formats are defined for platform attestations such as the [Android SafetyNet format](https://www.w3.org/TR/webauthn-2/#sctn-android-safetynet-attestation), no such format exists for TPM platform attestation. However, since the format was made with extensibility in mind, defining our own format within the overall scheme is straight-forward.

```
parsecTpmPlatStmtFormat = {
                 tpmVer: "2.0",
                 alg: COSEAlgorithmIdentifier,
                 kid: bytes,
                 sig: bytes,
                 attestInfo: bytes,
             }
```

- `tpmVer`: The version of the TPM specification to which the signature conforms.
- `alg`: A COSEAlgorithmIdentifier containing the identifier of the algorithm used to generate the attestation signature.
- `kid`: A UEID identifier that is shared between attester and verifier to uniquely identify the AIK (for example, a thumbprint of the public part of the key).
- `sig`: The attestation signature, in the form of a TPMT_SIGNATURE structure as specified in [TPMv2-Part2](https://trustedcomputinggroup.org/wp-content/uploads/TCG_TPM2_r1p59_Part2_Structures_pub.pdf) section 11.3.4.
- `attestInfo`: The TPMS_ATTEST structure over which the above signature was computed, as specified in [TPMv2-Part2](https://trustedcomputinggroup.org/wp-content/uploads/TCG_TPM2_r1p59_Part2_Structures_pub.pdf) section 10.12.8.

The actual attestation token produced by the TPM - the `TPMS_ATTEST` structure - is generated by a call to `TPM2_Quote` (see [TPMv2-Part3](https://trustedcomputinggroup.org/wp-content/uploads/TCG_TPM2_r1p59_Part3_Commands_pub.pdf) section 18.4) parameterized by a preconfigured (by the platform owner) list of PCRs.

Freshness of the attestation is given by a nonce provided by the RP - `relyingPartyNonce`. The nonce is passed in as the `extraData` field of TPMS_ATTEST.

## Verification procedure

The inputs to the verification procedure are as follows:

- an attestation statement in the format described above
- the `relyingPartyNonce` sent to the attester
- a database of reference values for various platforms

The steps for verifying the attestation:

- Verify that the attestation token is valid CBOR conforming to the syntax defined above and perform CBOR decoding on it to extract the contained fields.

- Verify that `alg` describes a valid, accepted signing algorithm.

- Verify the `sig` is a valid signature over `certInfo` using the key identified by `kid`, with the algorithm specified in `alg`.

- Verify that `aikCert` meets the requirements in § 8.3.1 TPM Attestation Statement Certificate Requirements.

- Verify that `attestInfo` is valid:

    * Verify that `magic` is set to TPM_GENERATED_VALUE.

    * Verify that `type` is set to TPM_ST_ATTEST_QUOTE.

    * Verify that `attested` contains a TPMS_QUOTE_INFO structure as specified in [TPMv2-Part2] section 10.12.4.

    * Extract `extraData` and parse it assuming the format defined above to obtain platform UUID and `relyingPartyNonce`. Verify that `relyingPartyNonce` is correct.
    
    * Verify that the platform UUID obtained earlier is valid and represents a platform found in the database.
    
    * Retrieve the reference values defined for this platform. Compute the digest of the concatenation of all relevant PCRs using the hash algorithm defined in `alg`. The PCRs are concatenated as described in "Selecting Multiple PCR", section 17.5 of [TPMv2 Part1](https://trustedcomputinggroup.org/wp-content/uploads/TCG_TPM2_r1p59_Part1_Architecture_pub.pdf). Verify that this digest is equal to `pcrDigest` in `attested` and that the hash algorithm defined in `pcrSelect` is aligned with the one in `alg`.

    * Note that the remaining fields in the "Standard Attestation Structure" [TPMv2-Part1] section 31.2, i.e., `qualifiedSigner`, `clockInfo` and `firmwareVersion` are ignored. These fields MAY be used as an input to risk engines.

- If successful, return the identity endorsed through `kid`.
